<html>
<head>
	<style>
		.headerSection {
			position:absolute;
			left:0; right:0;
			height: 70px;
			margin-left: 10px;
		}
		
		.filterSection {
			position:absolute;
			left:0; top:70px; bottom: 0;
			width: 200px;
			margin-left: 10px;
			margin-right: 10px;
		}
		
		.bodySection {
			position: absolute;
			left:220px; top:70px; right:0; bottom:0;
		}
		
		.filterSection select, .filterSection  input[type=text], .filterSection  input[type=date], .filterSection  input[type=number] {
			width: 200px;
			display: block;
		}
		
		.filterSection select[multiple] {
			border-right-width: 2px;
		}
		
		.filterForm {
			margin-bottom: 0;
		}
		
		.filterWrapper {
			padding-top:10px;
		}
		
		.filterButton {
			display: block;
			padding-top:10px;
			float:right;"
		}
		
		.exportReport {
			padding-right:10px;
		}
		
		.reportChart {
			min-height:inherit;
		}
		
		.yfReport, img.reportChart {
			height:inherit!important;
		}
		div.reportChart, reportChart {
			min-height: 600px !important;
		}
	</style>
	<script src="/JsAPI" type="text/javascript"></script>
	<script src="/JsAPI?api=auth" type="text/javascript"></script>
	<script src="/JsAPI?api=reports" type="text/javascript"></script>
</head>
<body>
	<div class="headerSection">
		<h2>Javascript API v<script>document.write(yellowfin.apiVersion);</script> & Soap Web-service Example</h2>
	</div>
	<div class="filterSection">
		<form name="filterForm" class="filterForm" >
			<div id="divDisplayFilters"></div>
		</form>
		<div class="filterButton" >
			<button id="btnRun" type="button" onclick="setReportFilters()">Apply Filters</button>
		</div>
	</div>
	<div class="bodySection">
		<table width="100%">
			<tr width="100%">
				<div id="divDisplayReport" width="100%" />
			</tr>
			<tr width="100%">
				<br/>
				<div style="display: none;" id="divExportReport" class="exportReport" align="right">
					<label>Export as : 
						<select id="selExportType" name="selExportType">
							<option value="application/pdf">PDF</option>
							<option value="application/msword">DOC</option>
							<option value="application/vnd.ms-excel">XLS</option>
						</select>
						<button id="btnExp" type="button" onclick="exportReport(selExportType.options[selExportType.selectedIndex].text, selExportType.options[selExportType.selectedIndex].value)">Export Report</button>
					</label>
				</div>
			</tr>
		</table>
	</div>
</body>
</html>
<script type="text/javascript">
	var scheme = window.location.protocol;
	var host = window.location.hostname;
	var port = window.location.port;
	
	var adminName = "support@aigs.co.za";
	var adminPass = "In5!ght5";
	var userName = "support@aigs.co.za";
	var userPass = "In5!ght5";
	var userComp = "";  //Default Org
	var reportUUID = 'df41eb4c-d90b-42ac-bdc1-fce7e4b48fe2'; //Athlete Demographic Spread
	//var reportUUID = 'f894a22c-373d-45b9-b7c0-922e70f0697d'; //Campaign Revenue by Gender
	//var reportUUID = 'f79b82d2-5d60-4cb8-89b6-994a90ef672a'; //Camp Region GIS Map
	//var reportUUID = '01c73f85-2da8-401c-8e1d-167a0a6b5b5c'; //Region Profit Summary
	var arrFilterValues = {};
	var xmlFilterValues = '';
	
	if (!(window.yellowfin)) {
		alert('Error loading Yellowfin API');
	}
	
	function getOperandDescription(_operator) {
		if (_operator == "EQUAL") {
			return " equal to ";
		} else if (_operator == "NOTEQUAL") {
			return " not equal to ";
		} else if (_operator == "GREATER") {
			return " greater than ";
		} else if (_operator == "GREATEREQUAL") {
			return " greater than or equal to ";
		} else if (_operator == "LESS") {
			return " less than ";
		} else if (_operator == "LESSEQUAL") {
			return " less than or equal to ";
		} else if (_operator == "BETWEEN") {
			return " between ";
		} else if (_operator == "NOTBETWEEN") {
			return " not between ";
		} else if (_operator == "INLIST") {
			return " in list ";
		} else if (_operator == "NOTINLIST") {
			return " not in list ";
		} else if (_operator == "CONTAINS") {
			return " contains ";
		} else if (_operator == "NOTCONTAINS") {
			return " does not contain ";
		} else if (_operator == "STARTSWITH") {
			return " starts with ";
		} else if (_operator == "NOTSTARTSWITH") {
			return " does not start with ";
		} else if (_operator == "ENDSWITH") {
			return " ends with ";
		} else if (_operator == "NOTENDSWITH") {
			return " does not end with ";
		}
	}
	
	function getReportFilters(filters, arg) {
		if (filters) {
			var filterArea = document.getElementById("divDisplayFilters");
			
			for (var i = 0; i < filters.length; i++) {
				var filterContainer = document.createElement("div");
				filterContainer.className = "filterWrapper";
				var filterLabel = null;
				var filterInput = null;
				var loopCounter = 1;
				
				if (filters[i].between) { loopCounter = 2; } else if (filters[i].list && filters[i].display == "TEXT") { loopCounter = 3; }
				for (var j = 1; j <= loopCounter; j++) {
					filterLabel = document.createElement("label");
					filterLabel.htmlFor = "filter-"+filters[i].filterId+"-val"+j;
					if (filters[i].between && j == 2) {
						filterLabel.innerHTML = "<i> and </i>";
					} else if (filters[i].list && j > 1){
						filterLabel.style.display = "none";
					} else {
						filterLabel.style.paddingTop = "10px";
						filterLabel.innerHTML = "<b>"+filters[i].description+"</b>";
						filterLabel.innerHTML += "<i>"+getOperandDescription(filters[i].operator)+"</i>";
					}
					
					if (filters[i].display == "ORGREFCODE_DROPDOWN" || filters[i].display == "CACHED_DROPDOWN" || filters[i].display == "CACHED_QUERY_DROPDOWN" || filters[i].display == "PREDEF_DATE_DROPDOWN") {
						filterInput = document.createElement("select");
						filterInput.id = "filter-"+filters[i].filterId+"-val"+j;
						filterInput.name = "filter-"+filters[i].filterId+"-val"+j;
						filterInput.filterId = filters[i].filterId;
						filterInput.filterUUID = filters[i].filterUUID;
						if (filters[i].operator == "INLIST" || filters[i].operator == "NOTINLIST") {
							filterInput.multiple = true;
						}
						if(filters[i].listValues) {
							var filterOption = document.createElement("option");
							filterOption.value = "";
							filterOption.text = "--Omit--";
							filterInput.appendChild(filterOption);
							for (var k = 0; k < filters[i].listValues.length; k++) {
								var filterOption = document.createElement("option");
								filterOption.value = filters[i].listValues[k].key;
								filterOption.text = filters[i].listValues[k].value;
								filterInput.appendChild(filterOption);
							}
						}
					} else if (filters[i].display == "DATE"){
						filterInput = document.createElement("INPUT");
						filterInput.setAttribute("type", "date");
						filterInput.id = "filter-"+filters[i].filterId+"-val"+j;
						filterInput.name = "filter-"+filters[i].filterId+"-val"+j;
						filterInput.filterId = filters[i].filterId;
						filterInput.filterUUID = filters[i].filterUUID;
					} else if (filters[i].display == "NUMERIC" || filters[i].display == "NUMERIC_SLIDER"){
						filterInput = document.createElement("INPUT");
						filterInput.setAttribute("type", "number");
						filterInput.id = "filter-"+filters[i].filterId+"-val"+j;
						filterInput.name = "filter-"+filters[i].filterId+"-val"+j;
						filterInput.filterId = filters[i].filterId;
						filterInput.filterUUID = filters[i].filterUUID;
					} else if (filters[i].display == "TEXT"){
						filterInput = document.createElement("input");
						filterInput.type = "text";
						filterInput.id = "filter-"+filters[i].filterId+"-val"+j;
						filterInput.name = "filter-"+filters[i].filterId+"-val"+j;
						filterInput.filterId = filters[i].filterId;
						filterInput.filterUUID = filters[i].filterUUID;
					}
					if (filters[i].list && filters[i].display == "TEXT") {
						if ("value1" in filters[i]) {
							var values = filters[i]["value1"].split("|");
							if (values[j-1]) filterInput.value = values[j-1];
						}
					} else {
						if ("value"+j in filters[i]) {
							filterInput.value = filters[i]["value"+j];
						}
					}
					
					filterContainer.appendChild(filterLabel);
					filterContainer.appendChild(filterInput);
					filterArea.appendChild(filterContainer);
				}
			}
		}
		setReportFilters();
	}
	
	function setReportFilters(filters) {
		arrFilterValues = {};
		xmlFilterValues = '';
		var elements = document.filterForm.elements;
		
		for (var e = 0; e < elements.length; e ++) {
			if (elements[e].value != "" && elements[e].value != "Omit") {
				if (elements[e].filterId in arrFilterValues) {
					if (Array.isArray(arrFilterValues[elements[e].filterId])) {
						arrFilterValues[elements[e].filterId].push(elements[e].value);
					} else {
						arrFilterValues[elements[e].filterId] = [arrFilterValues[elements[e].filterId], elements[e].value];
					}
				} else {
					if (elements[e].multiple) {
						var values = [];
						for (var i = 0; i < elements[e].options.length; i ++) {
							option = elements[e].options[i];
							if (option.selected) {
								values.push(option.value);
							}
						}
						arrFilterValues[elements[e].filterId] = values;
					} else {
						arrFilterValues[elements[e].filterId] = elements[e].value;
					}
				}
			}
		}
		for (var key in arrFilterValues) {
			if (Array.isArray(arrFilterValues[key])) {
				xmlFilterValues += '<ReportFilter><filterId>' + key + '</filterId><dataValue>' + arrFilterValues[key].join("|") + '</dataValue></ReportFilter>';
			} else {
				xmlFilterValues += '<ReportFilter><filterId>' + key + '</filterId><dataValue>' + arrFilterValues[key] + '</dataValue></ReportFilter>';
			}
		}
		setReportOptions();
	}
	
	function setReportOptions() {
		var options = {};
		options.reportUUID = reportUUID;
		options.elementId = 'divDisplayReport';
		options.showTitle = 'true';			//Default: true
		options.showInfo = 'true';			//Default: true
		options.showFilters = 'false';		//Default: true
		options.showSections = 'true';		//Default: true
		options.showSeries = 'false';		//Default: true
		options.showPageLinks = 'true';		//Default: true
		options.showExport = 'true';		//Default: true
		options.display = 'chart';
		options.fitTableWidth = 'false';
        
		options.filters = arrFilterValues;
		
		document.getElementById('divDisplayReport').innerHTML = "";
		yellowfin.loadReport(options);
		if (document.getElementById('divDisplayReport').innerHTML !== "") {
			document.getElementById('divExportReport').style.display = 'block';
		}
	}
	
	function loginUser() {
		yellowfin.auth.logonUser(userName, userPass, userComp, 'loginCallback', null);
	}
	
	function loginCallback (reqId, success, errors) {
		if (success) {
			yellowfin.reports.loadReportFilters(reportUUID, getReportFilters);
		} else {
			alert(errors);
		}
	}
	
	function exportReport(fileType, mimeType)
	{
		var xmlhttp = new XMLHttpRequest();
		var reportWsdl = "services/ReportService?wsdl";
		var wsdlPath = scheme+"//"+host+":"+port+"/"+reportWsdl;
		
		xmlhttp.open('POST', wsdlPath, true);
		var soapaction = '""';
		
		var soapRequest =	'<soapenv:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ser="http://service.web.mi.hof.com" xmlns:soapenc="http://schemas.xmlsoap.org/soap/encoding/">'
								+'<soapenv:Header/>'
								+'<soapenv:Body>'
									+'<ser:remoteReportCall soapenv:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/">'
										+'<req xsi:type="ser:ReportServiceRequest">'
											+'<objectName xsi:type="xsd:string">' + reportUUID + '</objectName>'
											+'<reportRequest xsi:type="xsd:string">' + fileType + '</reportRequest>'
											+'<loginId xsi:type="xsd:string">' + adminName + '</loginId>'
											+'<password xsi:type="xsd:string">' + adminPass + '</password>'
											+'<orgId xsi:type="xsd:int">1</orgId>'
											+'<reportUserId xsi:type="xsd:string">' + userName + '</reportUserId>'
											+'<reportUserPassword xsi:type="xsd:string">' + userPass + '</reportUserPassword>'
											+'<filters xsi:type="ser:ArrayOfReportFilter" soapenc:arrayType="ser:ReportFilter[]">' + xmlFilterValues + '</filters>'
										+'</req>'
									+'</ser:remoteReportCall>'
								+'</soapenv:Body>'
							+'</soapenv:Envelope>';
		xmlhttp.onreadystatechange = function () {
			if (xmlhttp.readyState == 4 && xmlhttp.status == 200)
			{
				var xmlResponse = xmlhttp.responseXML.documentElement;
				var status = xmlResponse.getElementsByTagName("statusCode")[0].childNodes[0].nodeValue;
				if (status == 'SUCCESS')
				{
					var reportBinary = xmlResponse.getElementsByTagName("binaryData")[0].childNodes[0].nodeValue;
					if (mimeType == "application/pdf") {
						var obj = document.createElement("object");
						obj.width = "100%";
						obj.height = "100%";
						obj.data = "data:" + mimeType + ";base64," + reportBinary;
						obj.type = mimeType;
						
						var win = window.open("","_blank","menubar=no,titlebar=no,toolbar=no");
						win.document.body.style.margin = "0";
						win.document.body.appendChild(obj);
					} else {
						window.open("data:" + mimeType + ";base64," + reportBinary);
					}
				}
			}
		}
		xmlhttp.setRequestHeader('Content-Type', 'text/xml');
		xmlhttp.setRequestHeader('SOAPAction', soapaction);
		xmlhttp.send(soapRequest);
	}
	
	loginUser();
</script>